<html>
<head>
<title>Shake Report</title>
<style type="text/css">
body {font-family: sans-serif;}
</style>

<script src="../output/self/.js"> </script>
<script src="jquery-1.7.1.min.js"> </script>

<script>
// first find which runs have built data in them, sorted
// built :: [Int]
var built = function(){
	var seen = {};
	for (var i = 0; i < shake.length; i++)
		seen[shake[i].built] = true;
	var seen2 = [];
	for (var i in seen)
		seen2.push(i);
	return seen2.sort(function cmp(a,b){return a-b;});
}();

// what is the index of the last build run
// lastRun :: Int
var lastRun = built.length == 0 ? 0 : built[built.length-1];

function showTime(x){return x.toFixed(1) + "s";}
function showShort(x){return x;}

function plural(n,not1,is1){
	return n == 1
		? (is1 == undefined ? "" : is1)
		: (not1 == undefined ? "s" : not1);
}


function summary()
{
	var countLast = 0;
	var countUnchanged = 0, countUnchangedLast = 0;
	var sumExecution = 0, sumExecutionLast = 0;
	var maxExecution = 0;
	var countTrace = 0, countTraceLast = 0;
	var sumTrace = 0;
	var maxTrace = 0;
	var maxTraceStopLast = 0;
	for (var i = 0; i < shake.length; i++)
	{
		var isLast = shake[i].built == lastRun;
		countLast += isLast ? 1 : 0;
		countUnchanged += shake[i].built != shake[i].changed ? 1 : 0;
		countUnchangedLast += isLast && shake[i].built != shake[i].changed ? 1 : 0;
		sumExecution += shake[i].execution;
		sumExecutionLast += isLast ? shake[i].execution : 0;
		maxExecution = Math.max(maxExecution, shake[i].execution);
		var traces = shake[i].traces;
		if (!traces) continue;
		for (var j = 0; j < traces.length; j++)
		{
			countTrace += 1;
			countTraceLast += isLast ? 1 : 0;
			sumTrace += traces[j].stop - traces[j].start;
			maxTrace = Math.max(maxTrace, traces[j].stop - traces[j].start);
			maxTraceStopLast = Math.max(maxTraceStopLast, isLast ? traces[j].stop : 0);
		}
	}

	var buckets = [];
	var countBuckets = 100;
	for (var i = 0; i <= countBuckets; i++)
		buckets.push(0); // fill with 1 more element, but the last bucket will always be 0

	for (var i = 0; i < shake.length; i++)
	{
		var traces = shake[i].traces;
		if (!traces || shake[i].built != lastRun) continue;
		for (var j = 0; j < traces.length; j++)
		{
			var start = traces[j].start * countBuckets / maxTraceStopLast;
			var stop = traces[j].stop * countBuckets / maxTraceStopLast;

			if (Math.floor(start) == Math.floor(stop))
				buckets[Math.floor(start)] += stop - start;
			else
			{
				for (var k = Math.ceil(start); k < Math.floor(stop); k++)
					buckets[k]++;
				buckets[Math.floor(start)] += Math.ceil(start) - start;
				buckets[Math.floor(stop)] += stop - Math.floor(stop);
			}
		}
	}
	var maxBucket = 0;
	for (var i = 0; i < countBuckets; i++)
		maxBucket = Math.max(maxBucket, buckets[i]);
	maxBucket = Math.ceil(maxBucket - 0.00001);

	var chart = "cht=lc&amp;chs=300x100&amp;chco=22AA47&amp;chm=B,6DC097,0,0,0&amp;chxt=y&amp;chxl=0:|0|" + maxBucket + "&amp;chls=3,1,0&amp;chd=t:";
	for (var i = 0; i < countBuckets; i++)
		chart += (i == 0 ? "" : ",") + (buckets[i] * 100 / maxBucket);

	$("#content").html(
		"<div style='float:right;margin-right:20px'>" +
			"<b>Traced commands</b><br/>" +
			"<img style='margin-top:5px;' width='300' height='100' src='https://chart.googleapis.com/chart?" + chart + "' />" +
		"</div>" +
		"<ul>" +
		"<li><b>Runs:</b> This database has tracked " + built.length + " run" + plural(built.length) + ".</li>" +
		"<li><b>Rules:</b> There are " + shake.length + " rules (" + countLast + " rebuilt in the last run).</li>" +
		"<li><b>Commands:</b> Building required " + countTrace + " traced commands (" + countTraceLast + " in the last run).</li>" +
		"<li><b>Build time:</b> The total (unparallelised) build time is " + showTime(sumExecution) + " of which " + showTime(sumTrace) + " is traced commands (" + showTime(sumExecutionLast) + " is the build time of the last run).</li>" +
		"<li><b>Longest steps:</b> The longest rule takes " + showTime(maxExecution) + ", and the longest traced command takes " + showTime(maxTrace) + ".</li>" +
		"<li><b>Unchanging rules:</b> There are " + countUnchanged + " rules whose result did not change on execution (" + countUnchangedLast + " from the last run).</li>" +
		"</ul>"
	);
}

$(summary);

</script>

</head>

<body>
<h1>Shake Summary Report</h1>
<div id="content">
	Loading...
</div>
</body>
</html>
